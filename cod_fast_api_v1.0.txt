from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pywizlight import wizlight, PilotBuilder
import logging

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI()

# Set up CORS
origins = [
    "http://localhost",
    "http://localhost:8000",
    "http://192.168.0.104",
    "http://192.168.0.105",
    "http://192.168.0.101",
    # Add any other origins as needed
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

#endpoint for the light bulbs state on/off

@app.get("/lights/{state}")
async def toggle_light(state: str):
    # Replace with the IP address of your bulb
    bulb_ip = "192.168.0.190"
    light = wizlight(bulb_ip)

    try:
        if state == "on":
            # Turn on the light
            await light.turn_on(PilotBuilder())
        elif state == "off":
            # Turn off the light
            await light.turn_off()
        else:
            raise HTTPException(status_code=400, detail="Invalid state. Use 'on' or 'off'.")
        return {"success": True}
    except Exception as e:
        logger.error(f"Error toggling light: {e}")
        raise HTTPException(status_code=500, detail="Failed to toggle light")


